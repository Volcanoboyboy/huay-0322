

# å¸¸è§„é¢è¯•é¢˜

## è¯¾ç¨‹ä»‹ç»

ç½—åˆ—å¸¸è§çš„é¢è¯•é¢˜ï¼ˆä»£ç å®ç°åŠåŸç†ï¼‰ï¼Œåˆ†æå…¶è€ƒç‚¹å’Œè§£ç­”æ€è·¯ï¼Œå¸®åŠ©å‰ç«¯å·¥ç¨‹å¸ˆæ¸©æ•…çŸ¥æ–°ï¼Œå¡«è¡¥è‡ªå·±çš„çŸ¥è¯†ç›²åŒºï¼Œåœ¨é¢è¯•ä¸­å–å¾—æ›´å¥½çš„è¡¨ç°ã€‚

## ä»£ç å®ç°é¢˜

### å®ç°call/apply/bind

è€ƒç‚¹:

- call/apply/bindçš„åŠŸèƒ½
- JSä¸­thisçš„æŒ‡å‘
- åŸå‹é“¾

#### JSä¸­thisçš„æŒ‡å‘

**1.å½“å‡½æ•°ä½œä¸ºæ„é€ å‡½æ•°ï¼Œé€šè¿‡new xxx()è°ƒç”¨æ—¶ï¼ŒthisæŒ‡å‘ç”Ÿæˆçš„å®ä¾‹**

```javascript
    function Cat(name,color){
        ã€€ã€€ã€€ã€€this.name=name;
        ã€€ã€€ã€€ã€€this.color=color;
        ã€€ã€€}
        let cat1 = new Cat("å¤§æ¯›","æ©˜è‰²");//thisæŒ‡å‘çš„cat1
        let cat2 = new Cat("äºŒæ¯›","é»‘è‰²");//thisæŒ‡å‘çš„cat2
        console.log(cat1); 
        console.log(cat2); 
```

**2.å½“å‡½æ•°ç›´æ¥è¢«è°ƒç”¨æ—¶ï¼ˆé€šè¿‡ xxx()çš„æ–¹å¼è°ƒç”¨ï¼‰thisæŒ‡å‘windowå¯¹è±¡,ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸ºundefined**

```javascript
    function Cat(name,color){
        ã€€ã€€ã€€ã€€this.name=name;
        ã€€ã€€ã€€ã€€this.color=color;
        ã€€ã€€}
       Cat("å¤§æ¯›","æ©˜è‰²");
       console.log(window.name)//å¤§æ¯›
       console.log(window.color)//æ©˜è‰²
```

**3.å½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæ˜¯ä½œä¸ºæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼ˆå‰é¢åŠ äº† ç‚¹'.'ï¼‰thisæŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼ˆç‚¹'.'å‰é¢çš„å¯¹è±¡ï¼‰**(è°è°ƒç”¨å®ƒï¼Œå®ƒå°±æŒ‡å‘è°)

```javascript
    function setDetails(name,color){
            ã€€ã€€ã€€ã€€this.name=name;
            ã€€ã€€ã€€ã€€this.color=color;
            ã€€ã€€}
    let cat={};
    cat.setDetails=setDetails;
    cat.setDetails('å¤§æ¯›','æ©˜è‰²');
    console.log(cat.name)//å¤§æ¯›
    console.log(cat.color)//æ©˜è‰²
```

æ€è€ƒ1

```javascript
    let obj={
        x:  10,
        fn: function(){
                function a(){
                    console.log(this.x)
                }
                a();
            }
    };
    obj.fn() //è¾“å‡ºä»€ä¹ˆï¼Ÿ
```

æ€è€ƒ2

```javascript
    let obj={
        x:  10,
        fn: function(){
                console.log(this.x)
            }
    };
    let a=obj.fn;
    obj.fn() //è¾“å‡ºä»€ä¹ˆï¼Ÿ
    a(); //è¾“å‡ºä»€ä¹ˆï¼Ÿ
```

æ€è€ƒ3

```javascript
    let obj={
            x:  10,
            fn: function(){
                	return function (){
                        console.log(this.x)
                    }
                }
        };
    obj.fn()() //è¾“å‡ºä»€ä¹ˆï¼Ÿ
```

#### å®ç°call

å‡½æ•°é€šè¿‡`call`è°ƒç”¨æ—¶ï¼Œå‡½æ•°ä½“å†…çš„`this`æŒ‡å‘`call`æ–¹æ³•ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå®å‚ï¼Œè€Œ`call`æ–¹æ³•åç»­çš„å®å‚ä¼šä¾æ¬¡ä¼ å…¥ä½œä¸ºåŸå‡½æ•°çš„å®å‚ä¼ å…¥ã€‚

```javascript
function setDetails(name,color){
            ã€€ã€€ã€€ã€€this.name=name;
            ã€€ã€€ã€€ã€€this.color=color;
            ã€€ã€€}
    let cat1={};
    let cat2={};
    setDetails.call(cat1,'å¤§æ¯›','æ©˜è‰²')
    setDetails.call(cat2,'äºŒæ¯›','é»‘è‰²')
    console.log(cat1.name)//å¤§æ¯›
    console.log(cat2.name)//äºŒæ¯›
```
```javascript
let person1 ={
  name:'zs',
  say:function (hobby) {
    console.log(this.name);
    console.log('çˆ±å¥½ï¼š'+ hobby);
  }
}
let person2 = {
  name:'ls'
}
person1.say('æ‰“æ¸¸æˆ')
person1.say.call(person2,'å¥èº«')
```

å¼€å§‹å®ç°ï¼š

å…ˆåœ¨åŸå‹é“¾ä¸ŠæŒ‚ä¸Šæˆ‘ä»¬è‡ªå®šä¹‰çš„`call2`æ–¹æ³•ï¼Œè®©æ‰€æœ‰å‡½æ•°å…±äº«æ­¤æ–¹æ³•ï¼š

```javascript
Function.prototype.call2 = function () {
  console.log(this);
}
setDetails.call2()
```

åœ¨`call2`ä¸­é€šè¿‡`this`æ‹¿åˆ°è°ƒç”¨`call2`çš„åŸå‡½æ•°ï¼Œæ¥ä¸‹æ¥é€šè¿‡ä¸Šé¢æåˆ°**å½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæ˜¯ä½œä¸ºæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼ˆå‰é¢åŠ äº† ç‚¹'.'ï¼‰thisæŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼ˆç‚¹'.'å‰é¢çš„å¯¹è±¡ï¼‰**æ”¹å˜åŸå‡½æ•°ä¸­`this`çš„æŒ‡å‘ï¼š

```javascript
Function.prototype.call2 = function (context) {
  //this === åŸå‡½æ•°
  console.log(this);

  //å°†åŸå‡½æ•°ä½œä¸ºcat1çš„æ–¹æ³•è°ƒç”¨
  context.setDetails = this
  context.setDetails()
}
```

ç»§ç»­æ”¹è¿›ï¼š

- å…¶å®å°†åŸå‡½æ•°ä½œä¸º`context`çš„æ–¹æ³•è°ƒç”¨æ—¶ï¼Œæ–¹æ³•åå¹¶ä¸å½±å“åŠŸèƒ½ï¼Œå°†æ–¹æ³•åå†™æ­»åè€Œå¯èƒ½ä¼šé€ æˆæ–¹æ³•åå†²çªã€‚åœ¨ES6ä¸­å¯ä»¥ç”¨`Symbol`æ¥è§£å†³ï¼Œå¦‚æœä¸ç”¨`Symbol`å¯ä»¥éšæœºç”Ÿæˆä¸€ä¸ªåŸºæœ¬ä¸å¯èƒ½å†²çªçš„å­—ç¬¦ä¸²ï¼Œä¸‡ä¸€å†²çªåˆ™ç»§ç»­ç”Ÿæˆåˆ°ä¸å†²çªä¸ºæ­¢
- åœ¨æ–¹æ³•è°ƒç”¨ååˆ é™¤æ–¹æ³•ï¼Œé¿å…ç»™`context`å¢åŠ å¤šä½™çš„æ–¹æ³•ã€‚
- åŸå‡½æ•°å¯èƒ½æœ‰è¿”å›å€¼ï¼Œè¦å°†æ”¹å˜`this`å¹¶è°ƒç”¨åçš„è¿”å›å€¼ä¹Ÿè¿”å›

```javascript
Function.prototype.call2 = function (context) {
  function mySymbol(obj) {
    let unique = (Math.random() + new Date())
    if (obj.hasOwnProperty(unique)) {
      return mySymbol(obj) //å¦‚æœè¿˜æ˜¯å†²çªï¼Œé€’å½’è°ƒç”¨
    } else {
      return unique
    }
  }
  let uniqueName = mySymbol(context)
  //this === åŸå‡½æ•°
  //console.log(this);

  //å°†åŸå‡½æ•°ä½œä¸ºcontextçš„æ–¹æ³•è°ƒç”¨
  context[uniqueName] = this
  let result = context[uniqueName]()
  //ç”¨å®Œåˆ é™¤
  delete context[uniqueName]
  return result
}
```

æ”¹è¿›è§£å†³å‚æ•°ä¼ é€’çš„é—®é¢˜ï¼š

- å› ä¸ºä¸çŸ¥é“ç”¨æˆ·åœ¨è°ƒç”¨æ—¶ä¼ å‚çš„ä¸ªæ•°ï¼Œè§£å†³å¯ä»¥é€šè¿‡`arguments`æˆ–è€…`å‰©ä½™å‚æ•°`æ¥è·å–é™¤äº†`context`å‰©ä½™çš„å‚æ•°ï¼Œå°†å‰©ä½™å‚æ•°ä¼ é€’ç»™`context[uniqueName]`

```javascript
Function.prototype.call2 = function (context) {
  function mySymbol(obj) {
    let unique = (Math.random() + new Date())
    if (obj.hasOwnProperty(unique)) {
      return mySymbol(obj) //å¦‚æœè¿˜æ˜¯å†²çªï¼Œé€’å½’è°ƒç”¨
    } else {
      return unique
    }
  }
  let uniqueName = mySymbol(context)

  //è·å–é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°å¤–å‰©ä½™çš„å‚æ•°
  let args = Array.from(arguments).slice(1)
  
  //this === åŸå‡½æ•°
  //å°†åŸå‡½æ•°ä½œä¸ºcat1çš„æ–¹æ³•è°ƒç”¨
  context[uniqueName] = this
  //ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ä¼ å‚ï¼Œå¯ä»¥è§£å†³å‚æ•°ä¸ç¡®å®šçš„é—®é¢˜
  let result = context[uniqueName](...args)

  //ç”¨å®Œåˆ é™¤
  delete context[uniqueName]
  return result
}
```

å°†å‰©ä½™å‚æ•°ä¼ é€’ç»™`context[uniqueName]`è¿˜å¯ä»¥é€šè¿‡`eval`æ¥æ‹¼æ¥è°ƒç”¨è¯­å¥ï¼š

```javascript
Function.prototype.call2 = function (context) {
  function mySymbol(obj) {
    let unique = (Math.random() + new Date())
    if (obj.hasOwnProperty(unique)) {
      return mySymbol(obj) //å¦‚æœè¿˜æ˜¯å†²çªï¼Œé€’å½’è°ƒç”¨
    } else {
      return unique
    }
  }
  let uniqueName = mySymbol(context)
  //this === åŸå‡½æ•°
  //console.log(this);
  //è·å–é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°å¤–å‰©ä½™çš„å‚æ•°
  let args = [];
  for(let i = 1; i < arguments.length; i++) {
    args.push('arguments[' + i + ']');
  }

  //å°†åŸå‡½æ•°ä½œä¸ºcat1çš„æ–¹æ³•è°ƒç”¨
  context[uniqueName] = this

  //ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ä¼ å‚ï¼Œå¯ä»¥è§£å†³å‚æ•°ä¸ç¡®å®šçš„é—®é¢˜
  let result = eval('context[uniqueName](' + args.join(',') + ')');

  //ç”¨å®Œåˆ é™¤
  delete context[uniqueName]
  return result
}
```



#### å®ç°apply

applyä¸callåŠŸèƒ½ä¸€è‡´ï¼Œä½†æ˜¯åœ¨è°ƒç”¨æ–¹å¼ä¸Šï¼Œæ˜¯å°†å‰©ä½™çš„å®å‚ä»¥ä¸€ä¸ªæ•°ç»„çš„æ–¹å¼ä¼ å‚ï¼š

```javascript
function setDetails(name,color){
            ã€€ã€€ã€€ã€€this.name=name;
            ã€€ã€€ã€€ã€€this.color=color;
            ã€€ã€€}
    let cat1={};
    let cat2={};
    setDetails.apply(cat1,['å¤§æ¯›','æ©˜è‰²'])
    setDetails.apply(cat2,['äºŒæ¯›','é»‘è‰²'])
    console.log(cat1.name)//å¤§æ¯›
    console.log(cat2.name)//äºŒæ¯›
```

å®ç°ä¸callåŸºæœ¬ä¸€è‡´ï¼Œæ³¨æ„å…¼å®¹`apply`ç¬¬äºŒä¸ªå‚æ•°æ²¡æœ‰ä¼ å…¥çš„æƒ…å†µ:

ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦

```javascript
Function.prototype.apply2 = function (context,args) {
  function mySymbol(obj) {
    let unique = (Math.random() + new Date())
    if (obj.hasOwnProperty(unique)) {
      return mySymbol(obj) //å¦‚æœè¿˜æ˜¯å†²çªï¼Œé€’å½’è°ƒç”¨
    } else {
      return unique
    }
  }
  let uniqueName = mySymbol(context)
  //this === åŸå‡½æ•°
  //console.log(this);


  args = args || [] //å…¼å®¹æ²¡æœ‰ä¼ å‚çš„æƒ…å†µ
  //å°†åŸå‡½æ•°ä½œä¸ºcontextçš„æ–¹æ³•è°ƒç”¨
  context[uniqueName] = this

  //ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ä¼ å‚ï¼Œå¯ä»¥è§£å†³å‚æ•°ä¸ç¡®å®šçš„é—®é¢˜
  context[uniqueName](...args)

  //ç”¨å®Œåˆ é™¤
  delete context[uniqueName]
}
```

ä½¿ç”¨eval:

```javascript
Function.prototype.apply2 = function (context,args) {
    function mySymbol(obj){
      let unique = (Math.random()+ new Date())
      if(obj.hasOwnProperty(unique)){
        return mySymbol(obj)
      }else {
        return unique
      }
    }
    let uniqueName = mySymbol(context)
    //let args = Array.from(arguments).slice(1)
    let arr = []
    for (let i = 0; i <args.length; i++) {
      arr.push('args[' + i + ']')
    }

    context[uniqueName] = this
/*    let result = context[uniqueName](args.join(',')) //ç­‰åŒäºcontext[uniqueName]('å¤§æ¯›','æ©˜è‰²')*/
    let result = eval('context[uniqueName](' + arr.join(',')+ ')')


    //åˆ é™¤ä¸´æ—¶æ–¹æ³•
    delete context[uniqueName]
    return result
  }
```

#### å®ç°bind

`bind`ä¸`call`å’Œ`apply`çš„åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†æœ‰ä¸åŒï¼Œ`bind`ä¸ä¼šç«‹å³è°ƒç”¨å‡½æ•°ï¼Œåªåš`this`çš„ç»‘å®šï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿è¡Œçš„é€»è¾‘ä¸åŸå‡½æ•°ä¸€è‡´ï¼Œä½†æ˜¯`this`ä¼šæŒ‡å‘ä¹‹å‰ç»‘å®šçš„å¯¹è±¡ã€‚

```javascript
function setDetails(name,color){
  this.name = name
  this.color = color
}
let cat1 = {}
let setDetails2 = setDetails.bind(cat1)
setDetails2('å¤§æ¯›','æ©˜è‰²')
```

å®ç°æ€è·¯ï¼š`bind`è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å‡½æ•°ä½“å†…è°ƒç”¨`apply`

```javascript
Function.prototype.bind2 = function (context) {
  let originFn = this;
  return function () {
    return originFn.apply(context);
  }
}
```

ç»§ç»­æ”¹è¿›ï¼š

è°ƒç”¨`bind`åè¿”å›çš„å‡½æ•°æ˜¯å¯ä»¥ä¼ å‚çš„ã€‚

`bind`æ–¹æ³•é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿˜å¯ä»¥é¢å¤–ä¼ å‚ï¼Œå¯ä»¥ç†è§£ä¸ºé¢„ä¼ å‚ã€‚

```javascript
function setDetails(name,color){
  this.name = name
  this.color = color
}
let cat1 = {}
let setDetails2 = setDetails.bind(cat1,'å¤§æ¯›')
setDetails2('æ©˜è‰²')
```

å°†ç¬¬ä¸€æ¬¡ä¼ å‚å…ˆå­˜èµ·æ¥ï¼Œåœ¨è°ƒç”¨æ—¶å°†ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡ä¼ å‚è¿›è¡Œæ‹¼æ¥ï¼š

```javascript
Function.prototype.bind2 = function (context) {
  let originFn = this;
  let args = Array.from(arguments).slice(1);
  return function () {
    let bindArgs = Array.from(arguments);
    return originFn.apply(context, args.concat(bindArgs));
  }
}
```

æœ€åæ”¹è¿›ï¼š

- `bind`**è¿”å›çš„å‡½æ•°**ï¼Œå¦‚æœä¹‹åæ˜¯ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨ï¼Œåˆ™**åŸå‡½æ•°**ä¸­çš„`this`ä¼šæŒ‡å‘åˆ›å»ºçš„å¯¹è±¡ï¼Œè€Œä¸ä¼šæŒ‡å‘ä¹‹å‰ç»‘å®šçš„å¯¹è±¡ï¼Œå¹¶ä¸”ç”Ÿæˆçš„å®ä¾‹ä»ç„¶å¯ä»¥ä½¿ç”¨åŸå‹å¯¹è±¡ä¸Šçš„å±æ€§ï¼š

```javascript
function Cat(name, color) {
  this.name = name
  this.color = color
}
Cat.prototype.miao = function(){console.log('å–µ~ï¼')}
let cat1 = {}
let CatBind = Cat.bind(cat1)
let cat2 = new CatBind('å¤§æ¯›','æ©˜è‰²')
cat2.miao()
```

å½“**è¿”å›çš„å‡½æ•°**ä½œä¸ºæ„é€ å‡½æ•°ï¼Œé€šè¿‡`new xxx()`è°ƒç”¨æ—¶ï¼Œè¿”å›çš„å‡½æ•°çš„`this`æŒ‡å‘ä»¥è¿”å›å‡½æ•°ä½œä¸ºæ„é€ ç”Ÿæˆçš„å®ä¾‹ã€‚å› æ­¤åªéœ€è¦åˆ¤æ–­`this instanceof è¿”å›çš„å‡½æ•°`ï¼Œå¦å¤–ï¼Œè¿”å›çš„å‡½æ•°è¦ç»§æ‰¿åŸå‡½æ•°ï¼ˆå°†åŸå‹é“¾è¿æ¥èµ·æ¥ï¼‰:

```javascript
Function.prototype.bind2 = function (context) {
  let originFn = this;
  let args = Array.from(arguments).slice(1);
  function fBind() {
    let bindArgs = Array.from(arguments);
    return originFn.apply(this instanceof fBind ? this /*ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨*/: context, args.concat(bindArgs));
  }
  fBind.prototype = Object.create(this.prototype) //ç»§æ‰¿
  return fBind
}
```



### å®ç° new

è€ƒç‚¹ï¼š

- æ„é€ å‡½æ•°ï¼ŒåŸå‹é“¾

å‡½æ•°é€šè¿‡`new` æ“ä½œç¬¦è°ƒç”¨ï¼Œæ­¤æ—¶å‡½æ•°è¢«ç§°ä¸ºæ„é€ å‡½æ•°ï¼Œè¿è¡Œåä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„`__proto__`å±æ€§æŒ‡å‘`æ„é€ å‡½æ•°.prototype`

```javascript
function Cat(name) {
  this.name = name
}
Cat.prototype.miao = function() {
  console.log('å–µ~ï¼');
}
let cat = new Cat('å¤§æ¯›')
console.log(cat.__proto__ === Cat.prototype); //true
```

ç”±äº`new`æ˜¯è¯­è¨€å±‚é¢çš„æ“ä½œç¬¦ï¼Œæ‰€ä»¥ç”¨å‡½æ•°æ¥æ¨¡æ‹Ÿ`new`çš„åŠŸèƒ½ï¼š

```javascript
function newFactory() {
  let constructor = arguments[0]
  let obj = Object.create(constructor.prototype)

  constructor.apply(obj, Array.from(arguments).slice(1));
  return obj
}

function Cat(name) {
  this.name = name
}
Cat.prototype.miao = function() {
  console.log('å–µ~ï¼');
}
let cat = newFactory(Cat,'å¤§æ¯›')
```

æ”¹è¿›ï¼šå½“æ„é€ å‡½æ•°æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªénullçš„å¯¹è±¡æ—¶ï¼Œåˆ™é€šè¿‡`new`ä¼šè¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œå…¶ä»–æƒ…å†µè¿˜æ˜¯ä¼šè¿”å›æ–°ç”Ÿæˆçš„å¯¹è±¡

```javascript
function Cat(name) {
  this.name = name
  return {
    name:'zs'
  }
}
Cat.prototype.miao = function() {
  console.log('å–µ~ï¼');
}
let cat = new Cat('å¤§æ¯›')
console.log(cat.name) //'zs'
```

å› æ­¤éœ€è¦å°†è°ƒç”¨`Cat`åè¿”å›çš„ç»“æœè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯énullçš„å¯¹è±¡ï¼Œåˆ™è¿”å›è¯¥å¯¹è±¡ï¼Œå…¶ä»–æƒ…å†µè¿”å›æ–°ç”Ÿæˆçš„å¯¹è±¡

```javascript
function newFactory() {
  let constructor = arguments[0]
  let obj = Object.create(constructor.prototype)
  let result = constructor.apply(obj, Array.from(arguments).slice(1));
  return result instanceof Object ? result : obj
}
function Cat(name) {
  this.name = name
  return {
    name:'zs'
  }
}
Cat.prototype.miao = function() {
  console.log('å–µ~ï¼');
}
let cat = new Cat('å¤§æ¯›')
```



### å®ç°é˜²æŠ–èŠ‚æµ

#### å®ç°é˜²æŠ–

æ¦‚å¿µï¼š åœ¨äº‹ä»¶è¢«è§¦å‘nç§’åå†æ‰§è¡Œå›è°ƒï¼Œå¦‚æœåœ¨è¿™nç§’å†…åˆè¢«è§¦å‘ï¼Œåˆ™é‡æ–°è®¡æ—¶ã€‚

ä¾‹å­ï¼šå¦‚æœæœ‰äººè¿›ç”µæ¢¯ï¼Œé‚£ç”µæ¢¯å°†åœ¨10ç§’é’Ÿåå‡ºå‘ï¼Œè¿™æ—¶å¦‚æœåˆæœ‰äººè¿›ç”µæ¢¯äº†ï¼Œæˆ‘ä»¬åˆå¾—ç­‰10ç§’å†å‡ºå‘ã€‚

æ€è·¯ï¼šé€šè¿‡é—­åŒ…ç»´æŠ¤ä¸€ä¸ªå˜é‡ï¼Œæ­¤å˜é‡ä»£è¡¨æ˜¯å¦å·²ç»å¼€å§‹è®¡æ—¶ï¼Œå¦‚æœå·²ç»å¼€å§‹è®¡æ—¶åˆ™æ¸…ç©ºä¹‹å‰çš„è®¡æ—¶å™¨ï¼Œé‡æ–°å¼€å§‹è®¡æ—¶ã€‚

```javascript
function debounce(fn, time) {
  let timer = null;
  return function () {
    let context = this
    let args = arguments
    if (timer) {
      clearTimeout(timer);
      timer = null;
    }
    timer = setTimeout(function () {
      fn.apply(context, args)
    }, time)
  }
}
window.onscroll = debounce(function(){
  console.log('è§¦å‘ï¼š'+ new Date().getTime());
},1000)
```

#### å®ç°èŠ‚æµ

æ¦‚å¿µï¼š è§„å®šä¸€ä¸ªå•ä½æ—¶é—´ï¼Œåœ¨è¿™ä¸ªå•ä½æ—¶é—´å†…ï¼Œåªèƒ½æœ‰ä¸€æ¬¡è§¦å‘äº‹ä»¶çš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªå•ä½æ—¶é—´å†…æŸäº‹ä»¶è¢«è§¦å‘å¤šæ¬¡ï¼Œåªæœ‰ä¸€æ¬¡èƒ½ç”Ÿæ•ˆã€‚

ä¾‹å­ï¼šæ¸¸æˆå†…çš„æŠ€èƒ½å†·å´ï¼Œæ— è®ºä½ æŒ‰å¤šå°‘æ¬¡ï¼ŒæŠ€èƒ½åªèƒ½åœ¨å†·å´å¥½äº†ä¹‹åæ‰èƒ½å†æ¬¡è§¦å‘

æ€è·¯ï¼šé€šè¿‡é—­åŒ…ç»´æŠ¤ä¸€ä¸ªå˜é‡ï¼Œæ­¤å˜é‡ä»£è¡¨æ˜¯å¦å…è®¸æ‰§è¡Œå‡½æ•°ï¼Œå¦‚æœå…è®¸åˆ™æ‰§è¡Œå‡½æ•°å¹¶ä¸”æŠŠè¯¥å˜é‡ä¿®æ”¹ä¸ºä¸å…è®¸ï¼Œå¹¶ä½¿ç”¨å®šæ—¶å™¨åœ¨è§„å®šæ—¶é—´åæ¢å¤è¯¥å˜é‡ã€‚

```javascript
function throttle(fn, time) {
  let canRun = true;
  return function () {
    if(canRun){
      fn.apply(this, arguments)
      canRun = false
      setTimeout(function () {
        canRun = true
      }, time)
    }
  }
}
window.onscroll = throttle(function(){
  console.log('è§¦å‘ï¼š'+ new Date().getTime());
},1000)
```

### å®ç°promise

Promiseæ˜¯ES6ä¸­çš„æ–°çš„å¼‚æ­¥è¯­æ³•ï¼Œè§£å†³äº†å›è°ƒåµŒå¥—çš„é—®é¢˜ï¼š

```javascript
new Promise((resolve)=>{
  setTimeout(()=>{
    resolve(1)
  },1000)
}).then(val =>{
  console.log(val);
  return new Promise((resolve)=>{
    setTimeout(()=>{
      resolve(2)
    },1000)
  })
}).then(val => {
  console.log(val);
})
```

#### å®ç°çŠ¶æ€åˆ‡æ¢

- promiseå®ä¾‹æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼Œ`pending`,`fulfilled`,`rejected`
- promiseå®ä¾‹åœ¨æ„é€ æ˜¯å¯ä»¥ä¼ å…¥æ‰§è¡Œå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°æœ‰ä¸¤ä¸ªå½¢å‚`resolve`,`reject`å¯ä»¥æ”¹å˜promiseçš„çŠ¶æ€ï¼Œpromiseçš„çŠ¶æ€ä¸€æ—¦æ”¹å˜åä¸å¯å†è¿›è¡Œæ”¹å˜ã€‚
- æ‰§è¡Œå‡½æ•°ä¼šåœ¨åˆ›å»ºpromiseå®ä¾‹æ—¶ï¼ŒåŒæ­¥æ‰§è¡Œ

```javascript
const PENDING = 'PENDING'; // åˆå§‹çŠ¶æ€
const FULFILLED = 'FULFILLED'; // æˆåŠŸçŠ¶æ€
const REJECTED = 'REJECTED'; // å¤±è´¥çŠ¶æ€
class Promise2 {
  constructor(executor){
    this.status = PENDING
    this.value = null
    this.reason = null
    const resolve = (value) => {
      if (this.status === PENDING) {
        this.value = value;
        this.status = FULFILLED;
      }
    }
    const reject = (reason) => {
      if (this.status === PENDING) {
        this.reason = reason;
        this.status = REJECTED;
      }
    }
    try {
      executor(resolve,reject)
    }catch (e) {
      reject(e)
    }

  }
}
let p = new Promise2((resolve,reject)=>{resolve(1)})
```

#### å®ç°`then`å¼‚æ­¥æ‰§è¡Œ

promiseå®ä¾‹å¯ä»¥è°ƒç”¨`then`æ–¹æ³•å¹¶ä¸”ä¼ å…¥å›è°ƒï¼š

å¦‚æœè°ƒç”¨`then`æ—¶ï¼ŒPromiseå®ä¾‹æ˜¯`fulfilled`çŠ¶æ€ï¼Œåˆ™é©¬ä¸Š**å¼‚æ­¥æ‰§è¡Œ**ä¼ å…¥çš„å›è°ƒã€‚

å¦‚æœè°ƒç”¨`then`æ—¶ï¼ŒPromiseå®ä¾‹æ˜¯`pending`çŠ¶æ€ï¼Œä¼ å…¥çš„å›è°ƒä¼šç­‰åˆ°resolveåå†**å¼‚æ­¥æ‰§è¡Œ**

ä¾‹å­ï¼š

```javascript
let p = new Promise((resolve, reject)=>{
  console.log(1);
  resolve(2)
  console.log(3);
})
p.then((val)=>{
  console.log(val);
})
//1
//3
//2
```

```javascript
let p = new Promise((resolve, reject)=>{
  setTimeout(()=>{
    resolve(1)
  },2000)
})
p.then((val)=>{
  console.log(val);
})
```

æ€è·¯ï¼šéœ€è¦ç”¨å›è°ƒå…ˆä¿å­˜åˆ°é˜Ÿåˆ—ä¸­ï¼Œåœ¨`resolve`åå¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„å›è°ƒï¼Œåœ¨`then`æ—¶åˆ¤æ–­å®ä¾‹çš„çŠ¶æ€å†å†³å®šæ˜¯å°†å›è°ƒæ¨å…¥é˜Ÿåˆ—ï¼Œè¿˜æ˜¯ç›´æ¥å¼‚æ­¥æ‰§è¡Œå›è°ƒï¼š

```javascript
const PENDING = 'PENDING'; // åˆå§‹çŠ¶æ€
const FULFILLED = 'FULFILLED'; // æˆåŠŸçŠ¶æ€
const REJECTED = 'REJECTED'; // å¤±è´¥çŠ¶æ€
class Promise2 {
  constructor(executor){
    this.status = PENDING
    this.value = null
    this.reason = null
    this.onFulfilledCallbacks = [];
    this.onRejectedCallbacks = [];
    const resolve = (value) => {
      if (this.status === PENDING) {
        this.value = value;
        this.status = FULFILLED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.value));
        })
      }
    }
    const reject = (reason) => {
      if (this.status === PENDING) {
        this.reason = reason;
        this.status = REJECTED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.reason));
        })
      }
    }
    try {
      executor(resolve,reject)
    }catch (e) {
      reject(e)
    }

  }
  then(onFulfilled, onRejected) {
    if (this.status === FULFILLED) {
      setTimeout(()=>{
        onFulfilled(this.value);
      })
    }
    if (this.status === REJECTED) {
      setTimeout(()=>{
        onRejected(this.reason);
      })

    }
    if (this.status === PENDING) {
      this.onFulfilledCallbacks.push(onFulfilled); // å­˜å‚¨å›è°ƒå‡½æ•°
      this.onRejectedCallbacks.push(onRejected); // å­˜å‚¨å›è°ƒå‡½æ•°
    }
  }
}
```

#### `resolve` Promiseå®ä¾‹çš„æƒ…å†µ

`resolve`çš„å€¼æœ‰å¯èƒ½ä¹Ÿæ˜¯ä¸ªpromiseå®ä¾‹ï¼Œè¿™æ—¶å€™å°±è¦ç”¨å‰è¿°å®ä¾‹è‡ªå·±`resolve`çš„å€¼

```javascript
let p = new Promise((resolve,reject) =>{  //promise1
  resolve(new Promise((resolve2,reject2)=>{  //promise2
    setTimeout(()=>{
      resolve2(1)
    },1000)
  }))
})
p.then((val)=>{
  console.log(val);
})
```

å› æ­¤éœ€è¦åœ¨promise1çš„`resolve`å‡½æ•°ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œæ˜¯promiseå®ä¾‹åˆ™åœ¨è¿™ä¸ªpromiseå®ä¾‹ï¼ˆpromise2ï¼‰åæ¥ä¸€ä¸ª`then`ï¼Œå¹¶ä¸”å°†promise1çš„`resolve`ä½œä¸ºå›è°ƒä¼ å…¥promise2çš„`then`

```javascript
const PENDING = 'PENDING'; // åˆå§‹çŠ¶æ€
const FULFILLED = 'FULFILLED'; // æˆåŠŸçŠ¶æ€
const REJECTED = 'REJECTED'; // å¤±è´¥çŠ¶æ€
class Promise2 {
  constructor(executor){
    this.status = PENDING
    this.value = null
    this.reason = null
    this.onFulfilledCallbacks = [];
    this.onRejectedCallbacks = [];
    const resolve = (value) => {
      if (value instanceof this.constructor) {
        value.then(resolve, reject); //resolve rejectæ˜¯ç®­å¤´å‡½æ•°ï¼Œthiså·²ç»ç»‘å®šåˆ°å¤–å±‚Promise
        return
      }
      if (this.status === PENDING) {
        this.value = value;
        this.status = FULFILLED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.value));
        })
      }
    }
    const reject = (reason) => {
      if (this.status === PENDING) {
        this.reason = reason;
        this.status = REJECTED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.reason));
        })
      }
    }
    try {
      executor(resolve,reject)
    }catch (e) {
      reject(e)
    }

  }
  then(onFulfilled, onRejected) {
    if (this.status === FULFILLED) {
      setTimeout(()=>{
        onFulfilled(this.value);
      })
    }
    if (this.status === REJECTED) {
      setTimeout(()=>{
        onRejected(this.reason);
      })

    }
    if (this.status === PENDING) {
      this.onFulfilledCallbacks.push(onFulfilled); // å­˜å‚¨å›è°ƒå‡½æ•°
      this.onRejectedCallbacks.push(onRejected); // å­˜å‚¨å›è°ƒå‡½æ•°
    }
  }
}
let p = new Promise2((resolve,reject) =>{
  resolve(new Promise2((resolve2,reject2)=>{
    setTimeout(()=>{
      resolve2(1)
    },1000)
  }))
})
p.then((val)=>{
  console.log(val);
})
```

#### å®ç°é“¾å¼è°ƒç”¨

`then`å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œè€Œä¸”å‰ä¸€ä¸ª`then`çš„å›è°ƒçš„è¿”å›å€¼ï¼Œå¦‚æœä¸æ˜¯promiseå®ä¾‹ï¼Œåˆ™ä¸‹ä¸€ä¸ª`then`å›è°ƒçš„ä¼ å‚å€¼å°±æ˜¯ä¸Šä¸€ä¸ª`then`å›è°ƒçš„è¿”å›å€¼ï¼Œå¦‚æœæ˜¯promiseå®ä¾‹ï¼Œåˆ™ä¸‹ä¸€ä¸ª`then`å›è°ƒçš„ä¼ å‚å€¼ï¼Œæ˜¯ä¸Šä¸€ä¸ª`then`å›è°ƒè¿”å›çš„promiseå®ä¾‹çš„è§£å†³å€¼(value)

```javascript
let p = new Promise((resolve,reject) =>{
    setTimeout(()=>{
      resolve(1)
    },1000)
})
p.then(val => {
  console.log(val);
  return new Promise((resolve) => {
    setTimeout(()=>{
      resolve(2)
    },1000)
  })
}).then(val => {
  console.log(val);
  return 3
}).then(val => {
  console.log(val);
})
```

æ—¢ç„¶èƒ½å¤Ÿé“¾å¼è°ƒç”¨ï¼Œé‚£ä¹ˆ`then`æ–¹æ³•æœ¬èº«çš„è¿”å›å€¼å¿…å®šæ˜¯ä¸€ä¸ªPromiseå®ä¾‹ã€‚é‚£ä¹ˆè¿”å›çš„promiseå®ä¾‹æ˜¯ä¸æ˜¯è‡ªèº«å‘¢ï¼Ÿç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼šä¸æ˜¯ã€‚å¦‚æœä¸€ä¸ªpromiseçš„thenæ–¹æ³•çš„è¿”å›å€¼æ˜¯promiseè‡ªèº«ï¼Œåœ¨newä¸€ä¸ªPromiseæ—¶ï¼Œè°ƒç”¨äº†resolveæ–¹æ³•ï¼Œå› ä¸ºpromiseçš„çŠ¶æ€ä¸€æ—¦æ›´æ”¹ä¾¿ä¸èƒ½å†æ¬¡æ›´æ”¹ï¼Œé‚£ä¹ˆä¸‹é¢çš„æ‰€æœ‰thenä¾¿åªèƒ½æ‰§è¡ŒæˆåŠŸçš„å›è°ƒï¼Œæ— æ³•è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œè¿™æ˜¾ç„¶å¹¶ä¸ç¬¦åˆpromiseçš„è§„èŒƒå’Œè®¾è®¡promiseçš„åˆè¡·ã€‚

å› æ­¤ `then`æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæ–°çš„promiseå®ä¾‹

```javascript
const PENDING = 'PENDING'; // åˆå§‹çŠ¶æ€
const FULFILLED = 'FULFILLED'; // æˆåŠŸçŠ¶æ€
const REJECTED = 'REJECTED'; // å¤±è´¥çŠ¶æ€
class Promise2 {
  constructor(executor){
    this.status = PENDING
    this.value = null
    this.reason = null
    this.onFulfilledCallbacks = [];
    this.onRejectedCallbacks = [];
    const resolve = (value) => {
      if (value instanceof this.constructor) {
        value.then(resolve, reject); //resolve rejectæ˜¯ç®­å¤´å‡½æ•°ï¼Œthiså·²ç»ç»‘å®šåˆ°å¤–å±‚Promise

        return
      }
      if (this.status === PENDING) {
        this.value = value;
        this.status = FULFILLED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.value));
        })
      }
    }
    const reject = (reason) => {
      if (this.status === PENDING) {
        this.reason = reason;
        this.status = REJECTED;
        setTimeout(()=>{
          this.onFulfilledCallbacks.forEach(fn => fn(this.reason));
        })
      }
    }
    try {
      executor(resolve,reject)
    }catch (e) {
      reject(e)
    }

  }
  then(onFulfilled, onRejected) {
    const promise2 = new this.constructor((resolve, reject) => { // å¾…è¿”å›çš„æ–°çš„promiseå®ä¾‹
      if (this.status === FULFILLED) {
          setTimeout(()=>{
            try {
              let callbackValue = onFulfilled(this.value);
              resolve(callbackValue);
            }catch(error) {
              reject(error) // å¦‚æœå‡ºé”™æ­¤æ¬¡çš„thenæ–¹æ³•çš„å›è°ƒå‡½æ•°å‡ºé”™ï¼Œåœ¨å°†é”™è¯¯ä¼ é€’ç»™promise2
            }
          })
      }
      if (this.status === REJECTED) {
        setTimeout(()=>{
          try {
            let callbackValue= onRejected(this.reason);
            resolve(callbackValue);
          } catch (error) {
            reject(error);
          }
        })

      }
      if (this.status === PENDING) {
        this.onFulfilledCallbacks.push(() => {
          try {
            let callbackValue = onFulfilled(this.value);
            resolve(callbackValue);
          }catch (error) {
            reject(error)
          }
        });
        this.onRejectedCallbacks.push(() => {
          try {
            let callbackValue = onRejected(this.reason);
            resolve(callbackValue);
          } catch (error) {
            reject(error);
          }
        });
      }
    })
    return promise2;
  }
}
```

#### å®ç°å…¶ä»–æ–¹æ³•

- catch
- resolve
- reject
- all
- race

æ–¹æ³•æ¼”ç¤ºï¼š

```javascript
/*catchæ–¹æ³•*/
let p = new Promise((resolve, reject) => {
  reject(1)
})
p.catch(reason => {
  console.log(reason);
})

/*Promise.resolve*/
let p = Promise.resolve(1)

/*Promise.resolve*/
let p = Promise.reject(1)

/*Promise.all*/
let p = Promise.all([
  new Promise(resolve => {
    setTimeout(() => {
      resolve(1)
    }, 1000)
  }),
  new Promise(resolve => {
    setTimeout(() => {
      resolve(2)
    }, 2000)
  }),
  new Promise(resolve => {
    setTimeout(() => {
      resolve(3)
    }, 3000)
  }),
])
p.then(val => {
  console.log(val);
})
/*Promise.race*/
let p = Promise.race([
  new Promise(resolve => {
    setTimeout(() => {
      resolve(1)
    }, 1000)
  }),
  new Promise(resolve => {
    setTimeout(() => {
      resolve(2)
    }, 2000)
  }),
  new Promise(resolve => {
    setTimeout(() => {
      resolve(3)
    }, 3000)
  }),
])
p.then(val => {
  console.log(val);
})
```



```javascript
const PENDING = 'PENDING'; // åˆå§‹çŠ¶æ€
const FULFILLED = 'FULFILLED'; // æˆåŠŸçŠ¶æ€
const REJECTED = 'REJECTED'; // å¤±è´¥çŠ¶æ€
class Promise2 {

  static resolve(value) {
    if (value instanceof this) {
      return value;
    }
    return new this((resolve, reject) => {
        resolve(value);
    });
  };

  static reject(reason) {
    return new this((resolve, reject) => reject(reason))
  };
  static all(promises){
    return new this((resolve, reject) => {
      let resolvedCounter = 0;
      let promiseNum = promises.length;
      let resolvedValues = new Array(promiseNum);
      for (let i = 0; i < promiseNum; i += 1) {
        Promise2.resolve(promises[i]).then(
          value => {
            resolvedCounter++;
            resolvedValues[i] = value;
            if (resolvedCounter === promiseNum) {
              return resolve(resolvedValues);
            }
          },
          reason => {
            return reject(reason);
          },
        );

      }
    });
  };
  static race(promises){
    return new this((resolve, reject) => {
      if (promises.length === 0) {
        return;
      } else {
        for (let i = 0, l = promises.length; i < l; i += 1) {
          Promise2.resolve(promises[i]).then(
            data => {
              resolve(data);
              return;
            },
            err => {
              reject(err);
              return;
            },
          );
        }
      }
    });
  }
  constructor(executor) {
    this.status = PENDING
    this.value = null
    this.reason = null
    this.onFulfilledCallbacks = [];
    this.onRejectedCallbacks = [];
    const resolve = (value) => {
      if (value instanceof this.constructor) {
        value.then(resolve, reject); //resolve rejectæ˜¯ç®­å¤´å‡½æ•°ï¼Œthiså·²ç»ç»‘å®šåˆ°å¤–å±‚Promise

        return
      }
      if (this.status === PENDING) {
        this.value = value;
        this.status = FULFILLED;
        setTimeout(() => {
          this.onFulfilledCallbacks.forEach(fn => fn(this.value));
        })
      }
    }
    const reject = (reason) => {
      if (this.status === PENDING) {
        this.reason = reason;
        this.status = REJECTED;
        setTimeout(() => {
          this.onFulfilledCallbacks.forEach(fn => fn(this.reason));
        })
      }
    }
    try {
      executor(resolve, reject)
    } catch (e) {
      reject(e)
    }

  }

  then(onFulfilled, onRejected) {
    const promise2 = new this.constructor((resolve, reject) => { // å¾…è¿”å›çš„æ–°çš„promiseå®ä¾‹
      if (this.status === FULFILLED) {

        setTimeout(() => {
          try {
            let callbackValue = onFulfilled(this.value);
            resolve(callbackValue);
          } catch (error) {
            reject(error) // å¦‚æœå‡ºé”™æ­¤æ¬¡çš„thenæ–¹æ³•çš„å›è°ƒå‡½æ•°å‡ºé”™ï¼Œåœ¨å°†é”™è¯¯ä¼ é€’ç»™promise2
          }
        })
      }
      if (this.status === REJECTED) {
        setTimeout(() => {
          try {
            let x = onRejected(this.reason);
            resolve(x);
          } catch (error) {
            reject(error);
          }
        })

      }
      if (this.status === PENDING) {
        this.onFulfilledCallbacks.push(() => {
          try {
            let callbackValue = onFulfilled(this.value);
            resolve(callbackValue);
          } catch (error) {
            reject(error)
          }
        });
        this.onRejectedCallbacks.push(() => {
          try {
            let callbackValue = onRejected(this.reason);
            resolve(callbackValue);
          } catch (error) {
            reject(error);
          }
        });
      }
    })
    return promise2;
  }

  catch(onRejected) {
    return this.then(null, onRejected);
  }
}
```



#### macrotaskå’Œmirotask

æ‰€è°“`macroTask`ï¼ˆå®ä»»åŠ¡ï¼‰æ˜¯æŒ‡å°†ä»»åŠ¡æ’åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œ`microTask`ï¼ˆå¾®ä»»åŠ¡ï¼‰æ˜¯æŒ‡å°†ä»»åŠ¡æ’åˆ°å½“å‰äº‹ä»¶å¾ªç¯çš„é˜Ÿå°¾ï¼Œæ‰§è¡Œæ—¶æœºä¼šè¢«å®ä»»åŠ¡æ›´æ—©ã€‚Promiseçš„æ ‡å‡†é‡Œæ²¡æœ‰è§„å®šPromiseé‡Œçš„å¼‚æ­¥è¯¥ä½¿ç”¨å“ªç§ï¼Œä½†åœ¨nodeå’Œæµè§ˆå™¨çš„å®ç°é‡Œéƒ½æ˜¯ä½¿ç”¨çš„`miroTask`ï¼ˆå¾®ä»»åŠ¡ï¼‰

![](.\img\2.png)

```javascript
setTimeout(() => {
  console.log(1);
}, 0)
let p = Promise.resolve(2)
p.then((val) => {
  console.log(val);
})
```

å®ä»»åŠ¡apiåŒ…æ‹¬ï¼š`setTimeout`,`setInterval`,`setImmediate(Node)`,`requestAnimationFrame(æµè§ˆå™¨)`,`å„ç§IOæ“ä½œï¼Œç½‘ç»œè¯·æ±‚`

å¾®ä»»åŠ¡apiåŒ…æ‹¬ï¼š`process.nextTick(Node)`,`MutationObserverï¼ˆæµè§ˆå™¨ï¼‰`

`MutaionObserver`æ¼”ç¤ºï¼š

```javascript
let observer = new MutationObserver(()=>{
  console.log(1);
})
let node = document.createElement('div')
observer.observe(node, { // ç›‘å¬èŠ‚ç‚¹
  childList: true // ä¸€æ—¦æ”¹å˜åˆ™è§¦å‘å›è°ƒå‡½æ•° nextTickHandler
})
node.innerHTML = 1
```

åˆ©ç”¨`MutaionObserver`å°è£…ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œå‡½æ•°

```javascript
let nextTick = (function () {
  let callbacks = []
  function nextTickHandler() {
    let copies = callbacks.slice(0)
    callbacks = []
    for (let i = 0; i < copies.length; i++) {
      copies[i]()
    }
  }

  let counter = 1
  let observer = new MutationObserver(nextTickHandler) // å£°æ˜ MO å’Œå›è°ƒå‡½æ•°
  let node = document.createElement('div')
  observer.observe(node, { // ç›‘å¬èŠ‚ç‚¹
    childList: true // ä¸€æ—¦æ”¹å˜åˆ™è§¦å‘å›è°ƒå‡½æ•° nextTickHandler
  })
  return function (cb) {
    callbacks.push(cb)
    counter = (counter + 1) % 2 //è®©èŠ‚ç‚¹å†…å®¹æ–‡æœ¬åœ¨ 1 å’Œ 0 é—´åˆ‡æ¢
    node.innerHTML = counter
  }
})()
```





## åŸç†é¢˜

### æµè§ˆå™¨ä»è¾“å…¥åœ°å€åˆ°é¡µé¢è¾“å‡º

#### ä¸»è¦æµç¨‹

![](.\img\7.png)

#### DNSåŸç†

DNSï¼ˆDomain Name Serverï¼‰ç”¨æ¥è¿”å›æŸä¸ªåŸŸåå¯¹åº”ä¸»æœºçš„ipçš„æœåŠ¡å™¨

**æ ¹DNS ï¼ˆ.ï¼‰**

åªè´Ÿè´£æä¾›å„ç±»é¡¶çº§DNSæœåŠ¡å™¨ipåœ°å€. æ˜¯åŸŸåè§£æçš„å…¥å£.

**é¡¶çº§DNS (TLD, Top Level Domain)**

è´Ÿè´£æä¾›äºŒçº§åŸŸåçš„DNSæœåŠ¡å™¨IPåœ°å€. æ¯ä¸€ä¸ªé¡¶çº§åŸŸåéƒ½æœ‰å¯¹åº”çš„DNSçš„æœåŠ¡å™¨,å®ƒä»¬é€šå¸¸ç”±ä¸“é—¨çš„æœºæ„å…¬å¸æ¥ç»´æŠ¤. æ¯”å¦‚`.com`ç”±`Verisign Global Registry Services`å…¬å¸ç»´æŠ¤,`.edu`ç”±`Educause`å…¬å¸ç»´æŠ¤. å®ƒä»¬å„è‡ªæä¾›è‡ªå®¶åŸŸåä¸‹çš„å­åŸŸåï¼ˆäºŒçº§åŸŸå)çš„åç§°æœåŠ¡. é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„"è´­ä¹°åŸŸå"å°±æ˜¯å‘è¿™äº›å…¬å¸çš„æ•°æ®åº“æ³¨å†Œä¸€æ¡è®°å½•.

**æƒå¨DNS**

è´Ÿè´£æä¾›ä¸‰çº§åŸŸåå¯¹åº”çš„ä¸»æœºIPåœ°å€ã€‚ç”±åŸŸåè´­ä¹°è€…æä¾›ï¼Œå¤§å¤šæ•°åŸŸåæ³¨å†Œå…¬å¸åŒæ—¶æä¾›äº†æƒå¨DNSæ‰˜ç®¡æœåŠ¡ã€‚

è·å–åŸŸåå¯¹åº”çš„æœåŠ¡å™¨ipçš„è¿‡ç¨‹ï¼š

1ï¼‰**æµè§ˆå™¨ç¼“å­˜**

ã€€ã€€å½“ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æŸåŸŸåæ—¶ï¼Œæµè§ˆå™¨é¦–å…ˆä¼šåœ¨è‡ªå·±çš„ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰è¯¥åŸŸåå¯¹åº”çš„IPåœ°å€ï¼ˆè‹¥æ›¾ç»è®¿é—®è¿‡è¯¥åŸŸåä¸”æ²¡æœ‰æ¸…ç©ºç¼“å­˜ä¾¿å­˜åœ¨ï¼‰ï¼›

2ï¼‰**ç³»ç»ŸHosts**

ã€€ã€€å½“æµè§ˆå™¨ç¼“å­˜ä¸­æ— åŸŸåå¯¹åº”IPåˆ™ä¼šè‡ªåŠ¨æ£€æŸ¥ç”¨æˆ·è®¡ç®—æœºç³»ç»ŸHostsæ–‡ä»¶æ˜¯å¦æœ‰è¯¥åŸŸåå¯¹åº”IPï¼›

3ï¼‰**æœ¬åœ°åŸŸåæœåŠ¡å™¨**

ã€€ã€€å½“åœ¨ç”¨æˆ·å®¢æœç«¯æŸ¥æ‰¾ä¸åˆ°åŸŸåå¯¹åº”IPåœ°å€ï¼Œåˆ™å°†è¿›å…¥æœ¬åœ°DNSç¼“å­˜ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚é€šå¸¸è¿™ä¸ªæœ¬åœ°åŸŸåDNSä¼šé…ç½®æˆè¿è¥å•†ï¼ˆISPï¼‰æŒ‡å®šçš„DNSï¼Œä½†ä¹Ÿä¸æ˜¯å¿…é¡»çš„ã€‚

4ï¼‰**è¿­ä»£æŸ¥è¯¢**

ã€€ã€€å½“ä»¥ä¸Šå‡æœªå®Œæˆï¼Œåˆ™ä¼šç”±æœ¬åœ°DNSå¼€å§‹è¿›è¡Œè¿­ä»£æŸ¥è¯¢ï¼š

- å‘æ ¹åŸŸåæœåŠ¡å™¨æŸ¥è¯¢ï¼Œå¾—åˆ°é¡¶çº§åŸŸåæœåŠ¡å™¨çš„IPåœ°å€
- å‘é¡¶çº§åŸŸåæœåŠ¡å™¨æŸ¥è¯¢ï¼Œå¾—åˆ°æƒå¨åŸŸåæœåŠ¡å™¨çš„IPåœ°å€
- å‘æƒå¨åŸŸåæœåŠ¡å™¨æŸ¥è¯¢ï¼Œæœ€ç»ˆå¾—åˆ°åŸŸåçš„ip

åˆ™è¿›å…¥æ ¹æœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ã€‚å…¨çƒä»…æœ‰13å°æ ¹åŸŸåæœåŠ¡å™¨ï¼Œ1ä¸ªä¸»æ ¹åŸŸåæœåŠ¡å™¨ï¼Œå…¶ä½™12ä¸ºè¾…æ ¹åŸŸåæœåŠ¡å™¨ã€‚æ ¹åŸŸåæ”¶åˆ°è¯·æ±‚åä¼šæŸ¥çœ‹åŒºåŸŸæ–‡ä»¶è®°å½•ï¼Œè‹¥æ— åˆ™å°†å…¶ç®¡è¾–èŒƒå›´å†…é¡¶çº§åŸŸåï¼ˆå¦‚.comï¼‰æœåŠ¡å™¨IPå‘Šè¯‰æœ¬åœ°DNSæœåŠ¡å™¨ï¼›

5ï¼‰**ä¿å­˜ç»“æœè‡³ç¼“å­˜**

ã€€ã€€æœ¬åœ°åŸŸåæœåŠ¡å™¨æŠŠè¿”å›çš„ç»“æœä¿å­˜åˆ°ç¼“å­˜ï¼Œä»¥å¤‡ä¸‹ä¸€æ¬¡ä½¿ç”¨ï¼ŒåŒæ—¶å°†è¯¥ç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªIPåœ°å€ä¸webæœåŠ¡å™¨å»ºç«‹é“¾æ¥ã€‚

![](.\img\1.png)



#### TCPä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹

ä¸ºä»€ä¹ˆtcpæ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸æ˜¯ä¸¤æ¬¡

![](.\img\6.png)



> â€œå·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€çš„äº§ç”Ÿåœ¨è¿™æ ·ä¸€ç§æƒ…å†µä¸‹ï¼šclientå‘å‡ºçš„ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µå¹¶æ²¡æœ‰ä¸¢å¤±ï¼Œè€Œæ˜¯åœ¨æŸä¸ªç½‘ç»œç»“ç‚¹é•¿æ—¶é—´çš„æ»ç•™äº†ï¼Œä»¥è‡´å»¶è¯¯åˆ°è¿æ¥é‡Šæ”¾ä»¥åçš„æŸä¸ªæ—¶é—´æ‰åˆ°è¾¾serverã€‚æœ¬æ¥è¿™æ˜¯ä¸€ä¸ªæ—©å·²å¤±æ•ˆçš„æŠ¥æ–‡æ®µã€‚ä½†serveræ”¶åˆ°æ­¤å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µåï¼Œå°±è¯¯è®¤ä¸ºæ˜¯clientå†æ¬¡å‘å‡ºçš„ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ã€‚äºæ˜¯å°±å‘clientå‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ŒåŒæ„å»ºç«‹è¿æ¥ã€‚å‡è®¾ä¸é‡‡ç”¨â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œé‚£ä¹ˆåªè¦serverå‘å‡ºç¡®è®¤ï¼Œæ–°çš„è¿æ¥å°±å»ºç«‹äº†ã€‚ç”±äºç°åœ¨clientå¹¶æ²¡æœ‰å‘å‡ºå»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œå› æ­¤ä¸ä¼šç†ç¬serverçš„ç¡®è®¤ï¼Œä¹Ÿä¸ä¼šå‘serverå‘é€æ•°æ®ã€‚ä½†serverå´ä»¥ä¸ºæ–°çš„è¿è¾“è¿æ¥å·²ç»å»ºç«‹ï¼Œå¹¶ä¸€ç›´ç­‰å¾…clientå‘æ¥æ•°æ®ã€‚è¿™æ ·ï¼Œserverçš„å¾ˆå¤šèµ„æºå°±ç™½ç™½æµªè´¹æ‰äº†ã€‚é‡‡ç”¨â€œä¸‰æ¬¡æ¡æ‰‹â€çš„åŠæ³•å¯ä»¥é˜²æ­¢ä¸Šè¿°ç°è±¡å‘ç”Ÿã€‚ä¾‹å¦‚åˆšæ‰é‚£ç§æƒ…å†µï¼Œclientä¸ä¼šå‘serverçš„ç¡®è®¤å‘å‡ºç¡®è®¤ã€‚serverç”±äºæ”¶ä¸åˆ°ç¡®è®¤ï¼Œå°±çŸ¥é“clientå¹¶æ²¡æœ‰è¦æ±‚å»ºç«‹è¿æ¥ã€‚â€



![](.\img\5.png)



TCPè¿æ¥å…³é—­æ—¶è¿›è¡Œå››æ¬¡æ¡æ‰‹è¿‡ç¨‹ğŸ‘‹

å®¢æˆ·ç«¯ï¼šâ€œä½ å¥½ï¼Œæˆ‘è¿™è¾¹æ²¡æœ‰æ•°æ®è¦ä¼ äº†ï¼Œæˆ‘è¦å…³é—­å’¯ã€‚â€

æœåŠ¡ç«¯ï¼šâ€œæ”¶åˆ°ï½æˆ‘çœ‹ä¸€ä¸‹æˆ‘è¿™è¾¹æœ‰æ²¡æ•°æ®è¦ä¼ çš„ã€‚â€

æœåŠ¡ç«¯ï¼šâ€œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ•°æ®è¦ä¼ å•¦ï¼Œæˆ‘ä»¬å¯ä»¥å…³é—­è¿æ¥å’¯ï½â€

å®¢æˆ·ç«¯ï¼šâ€okï½â€œ

#### httpç¼“å­˜

æµè§ˆå™¨ç¼“å­˜å¯ä»¥åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œ**å¼ºç¼“å­˜**å’Œ**åå•†ç¼“å­˜**ã€‚

å¼ºç¼“å­˜ï¼ˆæ— HTTPè¯·æ±‚ï¼Œæ— éœ€åå•†ï¼‰

ç›´æ¥è¯»å–æœ¬åœ°ç¼“å­˜ï¼Œæ— éœ€è·ŸæœåŠ¡ç«¯å‘é€è¯·æ±‚ç¡®è®¤ï¼Œhttpè¿”å›çŠ¶æ€ç æ˜¯200ï¼ˆfrom memory cacheæˆ–è€…from disk cache ï¼Œä¸åŒæµè§ˆå™¨è¿”å›çš„ä¿¡æ¯ä¸ä¸€è‡´çš„ï¼‰ã€‚

- å¯¹åº”çš„Http headeræœ‰:

- - Cache-Control
  - Expires

åå•†ç¼“å­˜ï¼ˆæœ‰HTTPè¯·æ±‚ï¼Œéœ€åå•†ï¼‰

æµè§ˆå™¨è™½ç„¶å‘ç°äº†æœ¬åœ°æœ‰è¯¥èµ„æºçš„ç¼“å­˜ï¼Œä½†æ˜¯ä¸ç¡®å®šæ˜¯å¦æ˜¯æœ€æ–°çš„ï¼Œäºæ˜¯æƒ³æœåŠ¡å™¨è¯¢é—®ï¼Œè‹¥æœåŠ¡å™¨è®¤ä¸ºæµè§ˆå™¨çš„ç¼“å­˜ç‰ˆæœ¬è¿˜å¯ç”¨ï¼Œé‚£ä¹ˆä¾¿ä¼šè¿”å›304ï¼ˆNot Modifiedï¼‰ httpçŠ¶æ€ç ã€‚

- å¯¹åº”çš„Http headeræœ‰:

- - Last-Modifiedï¼ˆç¼ºç‚¹åªèƒ½ç²¾ç¡®åˆ°1sï¼‰
  - ETag



| Http Header   | æè¿°                                              |
| ------------- | ------------------------------------------------- |
| Cache-Control | æŒ‡å®šç¼“å­˜æœºåˆ¶ï¼Œä¼˜å…ˆçº§æœ€é«˜                          |
| Pragma        | http1.0å­—æ®µï¼Œ**å·²åºŸå¼ƒ**ï¼Œä¸ºäº†å…¼å®¹ä¸€èˆ¬ä½¿ç”¨no-cache |
| Expires       | http1.0å­—æ®µ,æŒ‡å®šç¼“å­˜çš„è¿‡æœŸæ—¶é—´                    |
| Last-Modified | http1.0å­—æ®µï¼Œèµ„æºæœ€åä¸€æ¬¡çš„ä¿®æ”¹æ—¶é—´               |
| ETag          | å”¯ä¸€æ ‡è¯†è¯·æ±‚èµ„æºçš„å­—ç¬¦ä¸²ï¼Œä¼šè¦†ç›–Last-Modified     |

![](.\img\3.png)



#### æµè§ˆå™¨æ¸²æŸ“é¡µé¢

1. ä»HTMLè§£æå‡ºDOM Treeï¼ˆDOMæ ‘ï¼‰
2. ä»CSSè§£æå‡ºCSSOM Tree(CSSè§„åˆ™æ ‘)
3. JavaScriptä»£ç ç”±JavaScriptå¼•æ“å¤„ç†
4. DOMæ ‘å»ºç«‹åæ ¹æ®CSSæ ·å¼è¿›è¡Œæ„å»ºå†…éƒ¨ç»˜å›¾æ¨¡å‹ï¼Œç”ŸæˆRenderObjectæ ‘(æ¸²æŸ“æ ‘)
5. æ ¹æ®ç½‘é¡µå±‚æ¬¡ç»“æ„æ„å»ºRenderLayeræ ‘ï¼ŒåŒæ—¶æ„å»ºè™šæ‹Ÿç»˜å›¾ä¸Šä¸‹æ–‡(é‡æ’)
6. ä¾èµ–2Då’Œ3Då›¾å½¢åº“æ¸²æŸ“æˆå›¾åƒç»“æœå‘ˆç°åœ¨æµè§ˆå™¨ä¸­ï¼ˆé‡ç»˜ï¼‰

cssçš„ä¸‹è½½è¿‡ç¨‹ä¸ä¼šé˜»å¡è§£æï¼Œä½†JSä¼šç­‰å¾…å…¶ä¸‹è½½å¹¶æ‰§è¡Œå®Œæˆåæ‰ä¼šç»§ç»­è§£æã€‚JSä¸‹è½½æ—¶ï¼Œä¼šå¹¶è¡Œä¸‹è½½å…¶ä»–çš„èµ„æºã€‚

webkitå†…æ ¸æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹ä¸ºä¾‹ï¼š

![](.\img\4.png)



##### é‡ç»˜ä¸é‡æ’

ä¸€æ—¦æ¸²æŸ“æ ‘æ„å»ºå®Œæˆï¼Œå°±è¦å¼€å§‹ç»˜åˆ¶ï¼ˆpaintï¼‰é¡µé¢å…ƒç´ äº†ã€‚å½“DOMçš„å˜åŒ–åŒ…æ‹¬

- æ·»åŠ æˆ–åˆ é™¤å¯è§çš„DOMå…ƒç´ 
- å…ƒç´ ä½ç½®æ”¹å˜
- å…ƒç´ æœ¬èº«çš„å°ºå¯¸å‘ç”Ÿæ”¹å˜
- å†…å®¹æ”¹å˜
- é¡µé¢æ¸²æŸ“å™¨åˆå§‹åŒ–
- æµè§ˆå™¨çª—å£å¤§å°å‘ç”Ÿæ”¹å˜

å¯¼è‡´æµè§ˆå™¨ä¸å¾—ä¸é‡æ–°è®¡ç®—å…ƒç´ çš„å‡ ä½•å±æ€§ï¼Œå¹¶é‡æ–°æ„å»ºæ¸²æŸ“æ ‘ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œ**é‡æ’**â€ã€‚å®Œæˆé‡æ’åï¼Œè¦å°†é‡æ–°æ„å»ºçš„æ¸²æŸ“æ ‘æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯â€œ**é‡ç»˜**â€ã€‚

ç®€å•çš„è¯´ï¼Œé‡æ’è´Ÿè´£å…ƒç´ çš„**å‡ ä½•å±æ€§**æ›´æ–°ï¼Œé‡ç»˜è´Ÿè´£å…ƒç´ çš„**æ ·å¼**æ›´æ–°ã€‚è€Œä¸”ï¼Œ**é‡æ’å¿…ç„¶å¸¦æ¥é‡ç»˜ï¼Œä½†æ˜¯é‡ç»˜æœªå¿…å¸¦æ¥é‡æ’**ã€‚æ¯”å¦‚ï¼Œæ”¹å˜æŸä¸ªå…ƒç´ çš„èƒŒæ™¯ï¼Œè¿™ä¸ªå°±ä¸æ¶‰åŠå…ƒç´ çš„å‡ ä½•å±æ€§ï¼Œæ‰€ä»¥åªå‘ç”Ÿé‡ç»˜ã€‚

å‡å°‘é‡ç»˜å’Œé‡æ’çš„æªæ–½åŒ…æ‹¬ï¼š

- ä¸€æ¬¡æ€§æ”¹å˜æ ·å¼ï¼š

```javascript
var el = document.querySelector('.el');
el.style.borderLeft = '1px';
el.style.borderRight = '2px';
el.style.padding = '5px';
```

```javascript
var el = document.querySelector('.el');
el.style.cssText = 'border-left: 1px; border-right: 2px; padding: 5px';
//æˆ–è€…
// css 
.active {
    padding: 5px;
    border-left: 1px;
    border-right: 2px;
}
// javascript
var el = document.querySelector('.el');
el.className = 'active';
```



- éšè—å…ƒç´ ï¼Œè¿›è¡Œä¿®æ”¹åï¼Œç„¶åå†æ˜¾ç¤ºè¯¥å…ƒç´ 

```javascript
let ul = document.querySelector('#mylist');
ul.style.display = 'none';
appendNode(ul, data);
ul.style.display = 'block';
```

- ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µåˆ›å»ºä¸€ä¸ªå­æ ‘ï¼Œç„¶åå†æ‹·è´åˆ°æ–‡æ¡£ä¸­

```javascript
let fragment = document.createDocumentFragment();
appendNode(fragment, data);
ul.appendChild(fragment);
```

- å°†åŸå§‹å…ƒç´ æ‹·è´åˆ°ä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ä¸­ï¼Œæ“ä½œè¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åè¦†ç›–åŸå§‹å…ƒç´ 

```javascript
let old = document.querySelector('#mylist');
let clone = old.cloneNode(true);
appendNode(clone, data);
old.parentNode.replaceChild(clone, old);
```

- ç¼“å­˜å¸ƒå±€ä¿¡æ¯

```javascript
current = div.offsetLeft;
div.style.left = 1 + ++current + 'px';
div.style.top = 1 + ++current + 'px';
```







































































































































































































































